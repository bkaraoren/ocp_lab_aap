---
# =============================================================================
# Let's Encrypt Certificate Generation — Ansible version of generate-certs.sh
# =============================================================================
# Generates wildcard TLS certificates using acme.sh with name.com DNS-01.
#
# Usage:
#   cd ansible/
#   ansible-playbook playbooks/generate-certs.yml \
#     -e namecom_username=<user> -e namecom_api_token=<token>
# =============================================================================
- name: Generate Let's Encrypt certificates
  hosts: localhost
  gather_facts: true
  vars_files:
    - ../vars/main.yml

  vars:
    acme_sh_path: "{{ ansible_env.HOME }}/.acme.sh/acme.sh"
    cert_dir: "{{ ansible_env.HOME }}/.acme.sh/*.apps.{{ cluster_domain }}_ecc"
    wildcard_domain: "*.apps.{{ cluster_domain }}"
    api_domain: "api.{{ cluster_domain }}"

  pre_tasks:
    - name: "Validate required variables"
      ansible.builtin.assert:
        that:
          - namecom_username is defined and namecom_username | length > 0
          - namecom_api_token is defined and namecom_api_token | length > 0
        fail_msg: "namecom_username and namecom_api_token must be provided"

  tasks:
    # ─── Install acme.sh if not present ───
    - name: "Check if acme.sh is installed"
      ansible.builtin.stat:
        path: "{{ acme_sh_path }}"
      register: acme_sh_stat

    - name: "Install acme.sh"
      ansible.builtin.shell: |
        curl -sSL https://get.acme.sh | sh -s email={{ acme_email }}
      args:
        creates: "{{ acme_sh_path }}"
      when: not acme_sh_stat.stat.exists

    # ─── Issue certificates ───
    - name: "Issue wildcard + API certificate via DNS-01"
      ansible.builtin.command: >
        {{ acme_sh_path }} --issue
        -d "{{ wildcard_domain }}"
        -d "{{ api_domain }}"
        --dns dns_namecom
        --server letsencrypt
      environment:
        Namecom_Username: "{{ namecom_username }}"
        Namecom_Token: "{{ namecom_api_token }}"
      register: acme_issue
      # acme.sh returns 0 on success, 2 if cert already valid (skip renewal)
      failed_when: acme_issue.rc not in [0, 2]
      changed_when: acme_issue.rc == 0

    # ─── Verify the certificate ───
    - name: "Find certificate file"
      ansible.builtin.find:
        paths: "{{ ansible_env.HOME }}/.acme.sh"
        patterns: "*.apps.{{ cluster_domain }}.cer"
        recurse: true
      register: cert_files

    - name: "Display certificate details"
      ansible.builtin.command: >
        openssl x509 -in {{ cert_files.files[0].path }} -text -noout
      register: cert_info
      changed_when: false
      when: cert_files.files | length > 0

    - name: "Extract cert details"
      ansible.builtin.debug:
        msg: |
          ✅ Certificates generated successfully!

          {{ cert_info.stdout_lines | select('search', 'Subject:|Issuer:|Not Before:|Not After:|DNS:') | join('\n') }}

          Files location: {{ cert_files.files[0].path | dirname }}

          Next: Run store-secrets.yml to store the certs in Vault
      when: cert_files.files | length > 0
