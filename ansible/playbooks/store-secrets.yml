---
# =============================================================================
# Store All Cluster Secrets in Vault — Ansible version of store-secrets-in-vault.sh
# =============================================================================
# Populates Vault with all secrets needed by the cluster.
# Run AFTER Vault is initialized, unsealed, and configured.
#
# Usage:
#   cd ansible/
#   ansible-playbook playbooks/store-secrets.yml \
#     -e vault_root_token=hvs.xxxxx \
#     -e slack_webhook_url=https://hooks.slack.com/services/... \
#     -e namecom_username=<user> \
#     -e namecom_api_token=<token>
# =============================================================================
- name: Store all cluster secrets in Vault
  hosts: localhost
  gather_facts: true
  vars_files:
    - ../vars/main.yml

  vars:
    vault_cmd: "oc exec -n {{ vault_namespace }} {{ vault_pod }} -- sh -c"
    vt: "{{ vault_root_token }}"

  pre_tasks:
    - name: "Validate required variables"
      ansible.builtin.assert:
        that:
          - vault_root_token is defined and vault_root_token | length > 0
          - slack_webhook_url is defined and slack_webhook_url | length > 0
          - namecom_username is defined and namecom_username | length > 0
          - namecom_api_token is defined and namecom_api_token | length > 0
        fail_msg: "vault_root_token, slack_webhook_url, namecom_username, and namecom_api_token must be provided"

  tasks:
    # ─── 1. Google OAuth ───
    - name: "Get Google client ID from OAuth config"
      ansible.builtin.command: >
        oc get oauth cluster -o jsonpath='{.spec.identityProviders[?(@.name=="RedHatSSO")].google.clientID}'
      register: google_id_raw
      changed_when: false

    - name: "Get Google client secret name"
      ansible.builtin.command: >
        oc get oauth cluster -o jsonpath='{.spec.identityProviders[?(@.name=="RedHatSSO")].google.clientSecret.name}'
      register: google_secret_name
      changed_when: false

    - name: "Get Google client secret value"
      ansible.builtin.command: >
        oc get secret {{ google_secret_name.stdout }} -n openshift-config
        -o jsonpath='{.data.clientSecret}'
      register: google_secret_b64
      changed_when: false

    - name: "Decode Google client secret"
      ansible.builtin.set_fact:
        google_oauth_id: "{{ google_id_raw.stdout }}"
        google_oauth_secret: "{{ google_secret_b64.stdout | b64decode }}"

    - name: "Store Google OAuth credentials in Vault"
      ansible.builtin.shell: |
        {{ vault_cmd }} "VAULT_TOKEN='{{ vt }}' vault kv put secret/ocp/google-oauth \
          client_id='{{ google_oauth_id }}' \
          client_secret='{{ google_oauth_secret }}'"
      changed_when: true
      no_log: true

    - name: "  ✅ secret/ocp/google-oauth"
      ansible.builtin.debug:
        msg: "Stored"

    # ─── 2. Slack ───
    - name: "Store Slack webhook in Vault"
      ansible.builtin.shell: |
        {{ vault_cmd }} "VAULT_TOKEN='{{ vt }}' vault kv put secret/ocp/slack \
          webhook_url='{{ slack_webhook_url }}' \
          channel='{{ slack_channel }}'"
      changed_when: true
      no_log: true

    - name: "  ✅ secret/ocp/slack"
      ansible.builtin.debug:
        msg: "Stored"

    # ─── 3. AAP Gateway OAuthClient ───
    - name: "Get AAP Gateway OAuthClient secret"
      ansible.builtin.command: >
        oc get oauthclient aap-gateway -o jsonpath='{.secret}'
      register: aap_oauth_secret
      changed_when: false

    - name: "Store AAP Gateway OAuthClient in Vault"
      ansible.builtin.shell: |
        {{ vault_cmd }} "VAULT_TOKEN='{{ vt }}' vault kv put secret/ocp/aap-gateway-oauth \
          client_name='aap-gateway' \
          client_secret='{{ aap_oauth_secret.stdout }}'"
      changed_when: true
      no_log: true

    - name: "  ✅ secret/ocp/aap-gateway-oauth"
      ansible.builtin.debug:
        msg: "Stored"

    # ─── 4. AAP Admin ───
    - name: "Get AAP admin password"
      ansible.builtin.command: >
        oc get secret aap-admin-password -n {{ aap_namespace }}
        -o jsonpath='{.data.password}'
      register: aap_pw_b64
      changed_when: false

    - name: "Store AAP admin credentials in Vault"
      ansible.builtin.shell: |
        {{ vault_cmd }} "VAULT_TOKEN='{{ vt }}' vault kv put secret/aap/admin \
          username='{{ aap_admin_user }}' \
          password='{{ aap_pw_b64.stdout | b64decode }}'"
      changed_when: true
      no_log: true

    - name: "  ✅ secret/aap/admin"
      ansible.builtin.debug:
        msg: "Stored"

    # ─── 5. Portal secrets ───
    - name: "Get portal host URL"
      ansible.builtin.command: >
        oc get secret secrets-rhaap-portal -n {{ aap_portal_namespace }}
        -o jsonpath='{.data.aap-host-url}'
      register: portal_host_b64
      changed_when: false
      failed_when: false

    - name: "Get portal OAuth client ID"
      ansible.builtin.command: >
        oc get secret secrets-rhaap-portal -n {{ aap_portal_namespace }}
        -o jsonpath='{.data.oauth-client-id}'
      register: portal_oid_b64
      changed_when: false
      failed_when: false

    - name: "Get portal OAuth client secret"
      ansible.builtin.command: >
        oc get secret secrets-rhaap-portal -n {{ aap_portal_namespace }}
        -o jsonpath='{.data.oauth-client-secret}'
      register: portal_osec_b64
      changed_when: false
      failed_when: false

    - name: "Get portal AAP token"
      ansible.builtin.command: >
        oc get secret secrets-rhaap-portal -n {{ aap_portal_namespace }}
        -o jsonpath='{.data.aap-token}'
      register: portal_tok_b64
      changed_when: false
      failed_when: false

    - name: "Store portal secrets in Vault"
      ansible.builtin.shell: |
        {{ vault_cmd }} "VAULT_TOKEN='{{ vt }}' vault kv put secret/aap/portal \
          aap_host_url='{{ (portal_host_b64.stdout | b64decode) if portal_host_b64.rc == 0 and portal_host_b64.stdout | length > 0 else 'https://aap-' + aap_namespace + '.' + cluster_apps_domain }}' \
          oauth_client_id='{{ (portal_oid_b64.stdout | b64decode) if portal_oid_b64.rc == 0 and portal_oid_b64.stdout | length > 0 else 'REPLACE_ME' }}' \
          oauth_client_secret='{{ (portal_osec_b64.stdout | b64decode) if portal_osec_b64.rc == 0 and portal_osec_b64.stdout | length > 0 else 'REPLACE_ME' }}' \
          aap_token='{{ (portal_tok_b64.stdout | b64decode) if portal_tok_b64.rc == 0 and portal_tok_b64.stdout | length > 0 else 'REPLACE_ME' }}'"
      changed_when: true
      no_log: true

    - name: "  ✅ secret/aap/portal"
      ansible.builtin.debug:
        msg: "Stored"

    # ─── 6. SCM tokens ───
    - name: "Store SCM tokens (placeholder) in Vault"
      ansible.builtin.shell: |
        {{ vault_cmd }} "VAULT_TOKEN='{{ vt }}' vault kv put secret/aap/scm \
          github_token='placeholder' \
          gitlab_token='placeholder'"
      changed_when: true

    - name: "  ✅ secret/aap/scm"
      ansible.builtin.debug:
        msg: "Stored"

    # ─── 7. Vault tokens ───
    - name: "Store Vault tokens in Vault"
      ansible.builtin.shell: |
        {{ vault_cmd }} "VAULT_TOKEN='{{ vt }}' vault kv put secret/vault/tokens \
          root_token='{{ vt }}' \
          unseal_key='{{ vault_unseal_key | default('REPLACE_WITH_UNSEAL_KEY') }}'"
      changed_when: true
      no_log: true

    - name: "  ✅ secret/vault/tokens"
      ansible.builtin.debug:
        msg: "Stored"

    # ─── 8. Let's Encrypt certificates ───
    - name: "Find acme.sh cert directory"
      ansible.builtin.find:
        paths: "{{ ansible_env.HOME }}/.acme.sh"
        file_type: directory
        patterns: "*.apps.{{ cluster_domain }}_ecc"
      register: cert_dir_search

    - name: "Process Let's Encrypt certificates"
      when: cert_dir_search.files | length > 0
      block:
        - name: "Find private key file"
          ansible.builtin.find:
            paths: "{{ cert_dir_search.files[0].path }}"
            patterns: "*.key"
          register: key_files

        - name: "Read private key"
          ansible.builtin.slurp:
            src: "{{ key_files.files[0].path }}"
          register: tls_key

        - name: "Read fullchain certificate"
          ansible.builtin.slurp:
            src: "{{ cert_dir_search.files[0].path }}/fullchain.cer"
          register: tls_chain

        - name: "Read CA certificate"
          ansible.builtin.slurp:
            src: "{{ cert_dir_search.files[0].path }}/ca.cer"
          register: tls_ca

        - name: "Store Let's Encrypt certificates in Vault"
          ansible.builtin.shell: |
            {{ vault_cmd }} "VAULT_TOKEN='{{ vt }}' vault kv put secret/letsencrypt/certs \
              domain='*.apps.{{ cluster_domain }}' \
              alt_domain='api.{{ cluster_domain }}' \
              private_key_b64='{{ tls_key.content }}' \
              fullchain_b64='{{ tls_chain.content }}' \
              ca_b64='{{ tls_ca.content }}'"
          changed_when: true
          no_log: true

        - name: "  ✅ secret/letsencrypt/certs"
          ansible.builtin.debug:
            msg: "Stored"

    - name: "Skip Let's Encrypt certs (not found)"
      ansible.builtin.debug:
        msg: "⚠️  Skipping — run generate-certs.yml first, then re-run this playbook"
      when: cert_dir_search.files | length == 0

    # ─── 9. Registry pull secret ───
    - name: "Get registry pull secret"
      ansible.builtin.command: >
        oc get secret pull-secret -n openshift-config
        -o jsonpath='{.data.\.dockerconfigjson}'
      register: ps_b64
      changed_when: false

    - name: "Store registry pull secret in Vault"
      ansible.builtin.shell: |
        {{ vault_cmd }} "VAULT_TOKEN='{{ vt }}' vault kv put secret/registry/pull-secret \
          registry='registry.redhat.io' \
          dockerconfigjson_b64='{{ ps_b64.stdout }}'"
      changed_when: true
      no_log: true

    - name: "  ✅ secret/registry/pull-secret"
      ansible.builtin.debug:
        msg: "Stored"

    # ─── 10. DNS provider ───
    - name: "Store name.com DNS credentials in Vault"
      ansible.builtin.shell: |
        {{ vault_cmd }} "VAULT_TOKEN='{{ vt }}' vault kv put secret/dns/namecom \
          username='{{ namecom_username }}' \
          api_token='{{ namecom_api_token }}'"
      changed_when: true
      no_log: true

    - name: "  ✅ secret/dns/namecom"
      ansible.builtin.debug:
        msg: "Stored"

    # ─── Summary ───
    - name: "All secrets stored"
      ansible.builtin.debug:
        msg: |
          ============================================
          ✅ All secrets stored in Vault!
          ============================================
          Secrets stored:
            • secret/ocp/google-oauth
            • secret/ocp/slack
            • secret/ocp/aap-gateway-oauth
            • secret/aap/admin
            • secret/aap/portal
            • secret/aap/scm
            • secret/vault/tokens
            • secret/letsencrypt/certs {{ '✅' if cert_dir_search.files | length > 0 else '⚠️  SKIPPED' }}
            • secret/registry/pull-secret
            • secret/dns/namecom
